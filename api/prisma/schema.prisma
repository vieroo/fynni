// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  CHECKING
  SAVINGS
  WALLET
  INVESTMENT
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum CategoryType {
  INCOME
  EXPENSE
  BOTH
}

model User {
  id           String   @id @default(uuid())
  name         String?
  email        String   @unique
  passwordHash String?  @map("password_hash")
  avatarUrl    String?  @map("avatar_url")
  createdAt    DateTime @default(now()) @map("created_at")

  accounts        Account[]
  creditCards     CreditCard[]
  categories      Category[]
  transactions    Transaction[]
  billingPayments BillingPayment[]

  @@map("users")
}

model Account {
  id        String      @id @default(uuid())
  userId    String      @map("user_id")
  name      String
  type      AccountType
  balance   Float       @default(0)
  color     String?
  imageUrl  String?     @map("image_url")
  createdAt DateTime    @default(now()) @map("created_at")

  user          User          @relation(fields: [userId], references: [id])
  creditCards   CreditCard[]
  transactions  Transaction[] @relation("AccountTransactions")
  transfersFrom Transaction[] @relation("TransferFrom")
  transfersTo   Transaction[] @relation("TransferTo")

  @@map("accounts")
}

model CreditCard {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  accountId   String   @map("account_id")
  name        String
  limitAmount Float    @map("limit_amount")
  closingDay  Int      @map("closing_day")
  dueDay      Int      @map("due_day")
  createdAt   DateTime @default(now()) @map("created_at")

  user            User             @relation(fields: [userId], references: [id])
  account         Account          @relation(fields: [accountId], references: [id])
  transactions    Transaction[]
  billingPayments BillingPayment[]
}

model Category {
  id        String       @id @default(uuid())
  userId    String       @map("user_id")
  name      String
  icon      String?
  color     String?
  type      CategoryType
  createdAt DateTime     @default(now()) @map("created_at")

  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]

  @@map("categories")
}

model BillingPayment {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  creditCardId String   @map("credit_card_id")
  periodStart  DateTime @map("period_start")
  periodEnd    DateTime @map("period_end")
  amount       Float
  paidAt       DateTime @default(now()) @map("paid_at")

  user       User       @relation(fields: [userId], references: [id])
  creditCard CreditCard @relation(fields: [creditCardId], references: [id])

  @@unique([creditCardId, periodStart, periodEnd])
  @@map("billing_payments")
}

model InstallmentGroup {
  id                String   @id @default(uuid())
  totalAmount       Float    @map("total_amount")
  totalInstallments Int      @map("total_installments")
  description       String?
  createdAt         DateTime @default(now()) @map("created_at")

  transactions Transaction[]

  @@map("installment_groups")
}

model Transaction {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  type        TransactionType
  amount      Float
  date        DateTime
  description String?

  categoryId   String? @map("category_id")
  accountId    String? @map("account_id")
  creditCardId String? @map("credit_card_id")

  fromAccountId String? @map("from_account_id")
  toAccountId   String? @map("to_account_id")

  isInstallment      Boolean @default(false) @map("is_installment")
  installmentGroupId String? @map("installment_group_id")

  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  category   Category?   @relation(fields: [categoryId], references: [id])
  account    Account?    @relation("AccountTransactions", fields: [accountId], references: [id])
  creditCard CreditCard? @relation(fields: [creditCardId], references: [id])

  transferFrom Account? @relation("TransferFrom", fields: [fromAccountId], references: [id])
  transferTo   Account? @relation("TransferTo", fields: [toAccountId], references: [id])

  installmentGroup InstallmentGroup? @relation(fields: [installmentGroupId], references: [id])

  @@map("transactions")
}
